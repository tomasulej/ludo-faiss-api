//~ Copyright (C) 2014: W.G. Vree
//~ This program is free software; you can redistribute it and/or modify it under the terms of the
//~ GNU General Public License as published by the Free Software Foundation; either version 2 of
//~ the License, or (at your option) any later version.
//~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
//~ without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
//~ See the GNU General Public License for more details. <http://www.gnu.org/licenses/gpl.html>.
(function(){function y(b,a){for(var c=[];b;)c.push(a),--b;return c}function z(b,a){for(var c=0,d={};c<b.length;++c)d[b[c]]=a[c];return d}function w(b,a){var c=b.split(/%[ds]/);c.length>a.length&&a.push("");return a.map(function(a,b){return c[b]+a}).join("")}function q(b,a){p.info(w(b,a))}function C(b,a){return-1!==b.indexOf(a,b.length-a.length)}function D(b){return Object.keys(b).map(function(a){return parseInt(a)})}function H(b,a){var c=[],d;if(Array.isArray(b))for(d=0;d<b.length;++d)d in b&&c.push([d,
b[d]]);else for(d in b)c.push([d,b[d]]);c.sort(a?function(a,b){return a[0]-b[0]}:function(a,b){return a[1]-b[1]||b[0]-a[0]});return c}function I(b){this.reset();this.ixp=b;this.divs=this.mdur=this.ixm=0}function x(b,a){this.tijd=0;this.dur=b;this.fact=null;this.tup=[""];this.tupabc="";this.grace=this.beam=0;this.after=this.before="";this.ns=a?[a]:[];this.lyrs={};this.pos=0}function A(b){this.tijd=0;this.str=b;this.pos=0}function B(){}function r(b){this.maxtime=this.tijd=0;this.gMaten=[];this.gLyrics=
[];this.vnums={};this.cnt=new B;this.vceCnt=1;this.lastnote=null;this.bpl=b.b;this.cpl=b.n;this.repbra=0;this.nvlt=b.v}function E(b,a,c,d){this.fnmext=b;this.outlist=[];this.infolist=[];this.title="T:Title";this.key="none";this.clefs={};this.mtr="none";this.tempo=0;this.pad=a;this.X=c+1;this.denL=d.d;this.volpan=d.m;this.cmpL=[];this.rightmargin=this.leftmargin=this.pagewidth=this.scale="";4==d.p.length&&(this.scale=""!=d.p[0]?parseFloat(d.p[0]):"",this.pagewidth=""!=d.p[1]?parseFloat(d.p[1]):"",
this.leftmargin=""!=d.p[2]?parseFloat(d.p[2]):"",this.rightmargin=""!=d.p[3]?parseFloat(d.p[3]):"")}function Q(b,a){if(!b.join(""))return["",0];for(var c=[],d=0;d<b.length;++d){var f=b[d];""==f?f=a?"_":"*":C(f,"_")&&!C(f,"\\_")?(f=f.replace("_",""),a=1):a=0;c.push(f)}return[c.join(" "),a]}function G(b,a){for(var c=b,d=a,f;a;)f=b%a,b=a,a=f;return[c/b,d/b]}function J(b,a,c){if(0==b.dur)return"";var d;d=G(c*b.dur,4*a);a=d[0];c=d[1];b.fact&&(d=b.fact[0],b=b.fact[1],d=G(a*d,c*b),a=d[0],c=d[1]);64<c&&(d=
G(Math.round(64*a/c)||1,64),q("denominator too small: %d/%d rounded to %d/%d",[a,c,d[0],d[1]]),a=d[0],c=d[1]);return 1==a?1==c?"":2==c?"/":"/"+c:1==c?""+a:a+"/"+c}function K(b){var a=b.match(/([_^]*)([A-Ga-g])([',]*)/);if(!a)return-1;b=a[1];var c=a[2],a=a[3],d;d=c.toUpperCase();c=60+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(d)]+(d!=c?12:0);b&&(c+=("^"==b[0]?1:-1)*b.length);a&&(c+=("'"==a[0]?12:-12)*a.length);return c}function R(b,a,c,d){var f;f=0;0<=c.indexOf("stafflines=1")&&(f+=4);!d&&0<=c.indexOf("bass")&&
(f+=12);f&&(c="CDEFGAB".split(""),f=c.indexOf(b)+f,b=c[f%7],a+=Math.floor(f/7));4<a&&(b=b.toLowerCase());5<a&&(b+=Array(a-5+1).join("'"));4>a&&(b+=Array(4-a+1).join(","));return b}function L(b,a,c){var d=0,f,e,g=a[b];e=g.tup.indexOf("start");-1<e&&g.tup.splice(e,1);var h=b;for(c=[g.fact[0]/c[0],g.fact[1]/c[1]];b<a.length;){g=a[b];if(!(g instanceof A||g.grace)){-1<g.tup.indexOf("start")?(e=L(b,a,c),b=e[0],e=e[1],d+=e):g.fact&&(d+=1);e=g.tup.indexOf("stop");if(-1<e){g.tup.splice(e,1);break}if(!g.fact){b=
f;break}f=b}b+=1}f=[c[0],c[1],d];f="3,2,3"==f.toString()?"(3":w("(%d:%d:%d",f);a[h].tupabc=f+a[h].tupabc;return[b,d]}function S(b){b=b.filter(function(a){return a instanceof x});for(var a=0;a<b.length-1;){var c=b[a],d=b[a+1];!c.fact&&!d.fact&&0<c.dur&&d.beam&&(3*c.dur==d.dur?(d.dur=2*d.dur/3,c.dur*=2,c.after="<"+c.after,a+=1):3*d.dur==c.dur&&(c.dur=2*c.dur/3,d.dur*=2,c.after=">"+c.after,a+=1));a+=1}}function T(b,a,c,d,f){for(d=0;d<b.length;)c=b[d],c instanceof x&&c.fact&&(c=L(d,b,[1,1]),d=c[0]),d+=
1;d=[];for(var e,g=0;g<b.length;++g){c=b[g];if(c instanceof x){var h=J(c,a,f),l=1<c.ns.length;e=c.ns.filter(function(a){return C(a,"-")});e=e.map(function(a){return a.slice(0,-1)});var k="";l&&e.length==c.ns.length&&(c.ns=e,k="-");e=c.tupabc+c.before;l&&(e+="[");e+=c.ns.join("");l&&(e+="]"+k);C(e,"-")&&(e=e.slice(0,-1),k="-");e+=h+k;e+=c.after;c=c.beam}else e=c.str,c=1;c?d.push(e):d.push(" "+e)}return d.join("")}function U(b,a){b.map(function(a,b){a.pos=b});b.sort(function(a,b){return a.tijd-b.tijd||
a.pos-b.pos});for(var c=0,d=[],f=0;f<b.length;++f){var e=b[f];e.tijd>c&&d.push(new x(e.tijd-c,"x"));if(e instanceof A)e.tijd<c&&(e.tijd=c),d.push(e),c=e.tijd;else{if(e.tijd<c){if("z"==e.ns[0])continue;var g=d[d.length-1];if(g.tijd<=e.tijd)if("z"==g.ns[0])g.dur=e.tijd-g.tijd,0==g.dur&&pop(d),q("overlap in part %d, measure %d: rest shortened",[a.ixp+1,a.ixm+1]);else{g.ns=g.ns.concat(e.ns);q("overlap in part %d, measure %d: added chord",[a.ixp+1,a.ixm+1]);e.dur=e.tijd+e.dur-c;if(0>=e.dur)continue;e.tijd=
c}else{q("overlapping notes in one voice! part %d, measure %d, note %s discarded",[a.ixp+1,a.ixm+1,e instanceof x?e.ns:e.str]);continue}}d.push(e);c=e.tijd+e.dur}}0==c&&q("empty measure in part %d, measure %d, it should contain at least a rest to advance the time!",[a.ixp+1,a.ixm+1]);return d}function V(b){function a(a){a=w('<part-group number="%d" type="%s"></part-group>',[a,"stop"]);a=$.parseXML(a).firstChild;return $(a)}var c,d,f,e,g,h,l;c=[];d=[];h=b.children();for(g=0;g<h.length;g++)b=$(h[g]),
"part-group"==b[0].nodeName?(f=b.attr("number"),e=b.attr("type"),l=d.indexOf(f),"start"==e?-1<l?(c.push(a(f)),c.push(b)):(c.push(b),d.push(f)):-1<l&&(d.splice(l,1),c.push(b))):c.push(b);for(g=d.length-1;0<=g;--g)f=d[g],c.push(a(f));return c}function F(b,a,c){var d,f,e,g;if(0==b.length)return[[],[]];d=b.shift();if("part-group"==d[0].nodeName){f=d.attr("number");e=d.attr("type");if("start"==e){e=[];for(g in{"group-symbol":0,"group-barline":0,"group-name":0,"group-abbreviation":0})e.push(d.find(g).text()||
"");a[f]=e;c.push(f);g=F(b,a,c);b=g[0];d=g[1];g=F(d,a,c);a=g[0];c=g[1];return[[b].concat(a),c]}c=c.pop();b.length&&"stop"==b[0].attr("type")&&f!=c&&(g=a[c],a[c]=a[f],a[f]=g);a=a[f];return[[a],b]}g=F(b,a,c);a=g[0];b=g[1];return[[["name_tuple",d.find("part-name").text()||"",d.find("part-abbreviation").text()||""]].concat(a),b]}function M(b){var a,c,d,f;if(0==b.length)return[];a=[];for(d=0;d<b.length;++d){c=b[d];if(1==c.length)a.push(""+c[0]);else{a.push("(");for(f=0;f<c.length;++f)a.push(""+c[f]);a.push(")")}a.push("|")}a.splice(-1,
1);1<b.length&&(a=["{"].concat(a).concat(["}"]));return a}function N(b,a,c,d,f,e){if("name_tuple"==b[0])d=d.shift(),a[0]&&(b[1]=a[0]+":"+b[1],b[2]=a[1]+":"+b[2]),f.push(b),e.push.apply(e,M(d));else if(2==b.length)d=d.shift(),c=["name_tuple","",""],c[1]=b[0][1]+":"+b[1][2],c[2]=b[0][2]+":"+b[1][3],f.push(c),e.push.apply(e,M(d));else{var g,h,l;l=b[b.length-1];a=l[0];g=l[1];h=l[2];l=l[3];g="yes"==g||c;e.push("brace"==a?"{":"[");for(c=0;c<b.length-1;++c)N(b[c],[h,l],g,d,f,e),g&&e.push("|");g&&e.splice(-1,
1);e.push("brace"==a?"}":"]")}}function W(b){for(var a="",c=b.children(),d=0;d<c.length;++d){var f=c[d];switch(f.nodeName){case "elision":a+="~";break;case "text":a+=$(f).text().replace(/_/g,"\\_").replace(/-/g,"\\-").replace(/ /g,"~")}}if(!a)return a;c=b.find("syllabic").text();if("begin"==c||"middle"==c)a+="-";b.find("extend").length&&(a+="_");return a}function n(b){this.slurBuf={};this.wedge_type="";this.ingrace=0;this.msc=new r(b);this.unfold=b.u;this.ctf=b.c;this.gStfMap=[];this.midiMap=[];this.drumInst=
{};this.drumNotes={};this.instMid=[];this.midDflt=[-1,-1,-1,-91];this.msralts={};this.curalts={};this.stfMap={};this.clefMap={};this.curClef={};this.clefOct={};this.curStf={};this.nolbrk=b.x;this.doPageFmt=1==b.p.length;this.tstep=b.t}var X=Math.pow(2,53),O={"ornaments>trill-mark":"T","ornaments>mordent":"M","ornaments>inverted-mordent":"P","ornaments>turn":"!turn!","ornaments>inverted-turn":"!invertedturn!","ornaments>tremolo":"!///!","technical>up-bow":"u","technical>down-bow":"v","technical>harmonic":"!open!",
"technical>open-string":"!open!","technical>stopped":"!plus!","articulations>accent":"!>!","articulations>strong-accent":"!>!","articulations>staccato":".","articulations>staccatissimo":"!wedge!",fermata:"!fermata!",arpeggiate:"!arpeggio!","articulations>tenuto":"!tenuto!","articulations>staccatissimo":"!wedge!","articulations>spiccato":"!wedge!","articulations>breath-mark":"!breath!","articulations>detached-legato":"!tenuto!."},P={p:"!p!",pp:"!pp!",ppp:"!ppp!",f:"!f!",ff:"!ff!",fff:"!fff!",mp:"!mp!",
mf:"!mf!",sfz:"!sfz!"},p;xml2abc_VERSION=63;I.prototype.reset=function(){this.lline=this.attr="";this.rline="|";this.lnum=""};B.prototype.inc=function(b,a){this.counters[b][a]=(this.counters[b][a]||0)+1};B.prototype.clear=function(b){b=Object.keys(b);var a=y(b.length,0);this.counters={note:z(b,a),nopr:z(b,a),nopt:z(b,a)}};B.prototype.getv=function(b,a){return this.counters[b][a]};B.prototype.prcnt=function(b){for(var a in this.counters.note)0!=this.getv("nopr",a)&&q("part %d, voice %d has %d skipped non printable notes",
[b,a,this.getv("nopr",a)]),0!=this.getv("nopt",a)&&q("part %d, voice %d has %d notes without pitch",[b,a,this.getv("nopt",a)]),0==this.getv("note",a)&&q("part %d, skipped empty voice %d",[b,a])};r.prototype.initVoices=function(b){this.vtimes={};this.voices={};this.lyrics={};for(var a in this.vnums)this.vtimes[a]=0,this.voices[a]=[],this.lyrics[a]=[];b&&this.cnt.clear(this.vnums)};r.prototype.incTime=function(b){this.tijd+=b;this.tijd>this.maxtime&&(this.maxtime=this.tijd)};r.prototype.appendElemCv=
function(b,a){for(var c in b)this.appendElem(c,a)};r.prototype.insertElem=function(b,a){var c=new A(a);c.tijd=0;this.voices[b].unshift(c)};r.prototype.appendObj=function(b,a,c){a.tijd=this.tijd;this.voices[b].push(a);this.incTime(c);this.tijd>this.vtimes[b]&&(this.vtimes[b]=this.tijd)};r.prototype.appendElem=function(b,a,c){this.appendObj(b,new A(a),0);c&&this.cnt.inc("note",b)};r.prototype.appendNote=function(b,a,c){a.ns.push(c);this.appendObj(b,a,parseInt(a.dur));"z"!=c&&"x"!=c&&(this.lastnote=
a,this.cnt.inc("note",b),a.grace||this.lyrics[b].push(a.lyrs))};r.prototype.getLastRec=function(b){return this.gMaten.length?(b=this.gMaten[this.gMaten.length-1][b],b[b.length-1]):null};r.prototype.getLastMelis=function(b,a){if(this.gLyrics.length){var c=this.gLyrics[this.gLyrics.length-1][b];if(a in c)return c[a][1]}return 0};r.prototype.addChord=function(b){this.lastnote.ns.push(b)};r.prototype.addBar=function(b,a){a.mdur&&this.maxtime>a.mdur&&q("measure %d in part %d longer than metre",[a.ixm+
1,a.ixp+1]);this.tijd=this.maxtime;for(var c in this.vnums){if(a.lline||a.lnum){var d=this.getLastRec(c);if(d){var f=d.str;a.lline&&(f=(f+a.lline).replace(/:\|:/g,"::").replace(/\|\|/g,"|"));3==this.nvlt?a.ixp+parseInt(c)==Math.min.apply(null,D(this.vnums))&&(f+=a.lnum):4==this.nvlt?parseInt(c)==Math.min.apply(null,D(this.vnums))&&(f+=a.lnum):a.lnum&&(f+=a.lnum,this.repbra=1);d.str=f}else a.lline&&this.insertElem(c,"|:")}b&&(d=this.getLastRec(c))&&(d.str+=b);a.attr&&this.insertElem(c,""+a.attr);this.appendElem(c,
" "+a.rline);this.voices[c]=U(this.voices[c],a);for(var d=this.lyrics[c],f={},e=d.reduce(function(a,b){return a.concat(D(b))},[]),g=Math.max.apply(null,e.concat([0]));0<g;--g){var e=d.map(function(a){return a[g]||""}),h=this.getLastMelis(c,g);f[g]=Q(e,h)}this.lyrics[c]=f;S(this.voices[c])}this.gMaten.push(this.voices);this.gLyrics.push(this.lyrics);this.tijd=this.maxtime=0;this.initVoices()};r.prototype.outVoices=function(b,a){var c,d,f,e,g,h,l,k,m;g={};l=Math.min.apply(null,D(this.vnums));for(k in this.vnums)if(0!=
this.cnt.getv("note",k)){if(p.denL)h=p.denL;else{var s=k,t=this.gMaten;h=b;m=0;e=X;d=c=void 0;for(var n=[4,8,16];n.length;){var u=n.shift(),q=0;for(c=0;c<t.length;++c){var r=t[c][s];for(d=0;d<r.length;++d){var v=r[d];v instanceof A||0==v.dur||(q+=J(v,h,u).length)}}q<e&&(m=u,e=q)}h=m}p.cmpL.push(h);s=[];t={};for(m=0;m<this.gMaten.length;++m){e=this.gMaten[m][k];s.push(T(e,b,m,a,h));d=this.gLyrics;if(0!=m)for(n in e=this.gMaten[m][k],c=d[m][k],d=d[m-1][k],u=u=n=void 0,d)if(u=d[n][1],!(n in c)&&u){u=
e;q=[];for(r=0;r<u.length;++r)if(v=u[r],v instanceof x&&!v.grace){if("z"==v.ns[0]||"x"==v.ns[0])break;q.push("_")}(u=q.join(" "))&&(c[n]=[u,0])}c=this.gLyrics[m][k];for(f in c)if(e=c[f],e=e[0],f in t){for(;t[f].length<m;)t[f].push("");t[f].push(e)}else t[f]=y(m,"").concat([e])}for(f in t)e=t[f],h=s.length-e.length,t[f]=e.concat(y(h,""));p.add("V:"+this.vceCnt);this.repbra&&(1==this.nvlt&&1<this.vceCnt&&p.add("I:repbra 0"),2==this.nvlt&&parseInt(k)>l&&p.add("I:repbra 0"));0<this.cpl?this.bpl=0:0==
this.bpl&&(this.cpl=100);for(h=0;s.length;){m=1;for(e=s[0];m<s.length&&!(0<this.cpl&&e.length+s[m].length>=this.cpl)&&!(0<this.bpl&&m>=this.bpl);)e+=s[m],m+=1;h+=m;p.add(e+" %"+h);s.splice(0,m);c=H(t,1);for(d=0;d<c.length;++d)e=c[d],f=e[0],e=e[1],p.add("w: "+e.slice(0,m).join("|")+"|"),e.splice(0,m)}g[k]=this.vceCnt;this.vceCnt+=1}this.gMaten=[];this.gLyrics=[];this.cnt.prcnt(a+1);return g};E.prototype.add=function(b){this.outlist.push(b+"\n")};E.prototype.info=function(b,a){this.infolist.push(("undefined"==
typeof a||a?"-- ":"")+b)};E.prototype.mkHeader=function(b,a,c){var d=[],f=[],e,g,h,l,k,m;l=b.slice();for(m=0;m<a.length;++m){e=a[m];try{N(e,["",""],"",b,d,f)}catch(s){q("lousy musicxml: error in part-list",[])}}a=f.join(" ");b={};for(m=0;m<l.length;++m)g=l[m],e=d[m],h=e[1],e=e[2],0!=g.length&&(g=g[0][0],h=h.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),e=e.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),b[g]=(h?'nm="'+h+'"':"")+(e?' snm="'+e+'"':""));d=[w("X:%d\n%s\n",
[this.X,this.title])];""!==this.scale&&d.push("%%scale "+this.scale+"\n");""!==this.pagewidth&&d.push("%%pagewidth "+this.pagewidth+"cm\n");""!==this.leftmargin&&d.push("%%leftmargin "+this.leftmargin+"cm\n");""!==this.rightmargin&&d.push("%%rightmargin "+this.rightmargin+"cm\n");a&&1<f.length&&d.push("%%score "+a+"\n");l=this.tempo?"Q:1/4="+this.tempo+"\n":"";f=[];for(m=0;m<this.cmpL.length;++m)e=this.cmpL[m],f[e]=(f[e]||0)+1;f=H(f);f=f[f.length-1][0];f=this.denL?this.denL:f;d.push(w("L:1/%d\n%sM:%s\n",
[f,l,this.mtr]));d.push(w("I:linebreak $\nK:%s\n",[this.key]));for(k in this.clefs){e=c[k-1];m=e[0];a=e[1];h=e[1];g=e[3];l=e.slice(4);e=this.clefs[k];l.length&&0>e.indexOf("perc")&&(e=(e+" map=perc").trim());d.push(w("V:%d %s %s\n",[k,e,b[k]||""]));1<this.volpan?(0<m&&m!=k&&d.push("%%MIDI channel "+m+"\n"),0<a&&d.push("%%MIDI program "+(a-1)+"\n"),0<=h&&d.push("%%MIDI control 7 "+h+"\n"),0<=g&&d.push("%%MIDI control 10 "+g+"\n")):0<this.volpan&&(l.length&&0<m&&d.push("%%MIDI channel "+m+"\n"),0<a&&
d.push("%%MIDI program "+(a-1)+"\n"));for(m=0;m<l.length;++m)if(e=l[m].nt,h=l[m].step,a=l[m].midi,(g=l[m].nhd)||(g="normal"),K(e)!=a||e!=h)0<this.volpan&&d.push("%%MIDI drummap "+e+" "+a+"\n"),d.push("I:percmap "+e+" "+h+" "+a+" "+g+"\n");f!=this.cmpL[k-1]&&d.push("L:1/"+this.cmpL[k-1]+"\n")}this.outlist=d.concat(this.outlist)};n.prototype.matchSlur=function(b,a,c,d,f,e){if(-1!=["start","stop"].indexOf(b))if(a||(a="1"),a in this.slurBuf){var g=this.slurBuf[a],h=g[0],l=g[1],k=g[2],g=g[3];b!=h?(c!=
l||"start"!=h||g&&e||(k.before="("+k.before,d.after+=")"),delete this.slurBuf[a]):(q("double slur numbers %s-%s in part %d, measure %d, voice %d note %s, first discarded",[b,a,this.msr.ixp+1,this.msr.ixm+1,c,d.ns]),this.slurBuf[a]=[b,c,d,f])}else this.slurBuf[a]=[b,c,d,f]};n.prototype.doNotations=function(b,a){for(var c=Object.keys(O).sort(),d=0;d<c.length;++d){var f=c[d],e=O[f];a.find(f).length&&(b.before+=e)}c=a.find("technical>fingering");c.length&&(b.before+="!"+c.text()+"!");c=a.find("ornaments>wavy-line");
if(c.length)switch(c.attr("type")){case "start":b.before="!trill(!"+b.before;break;case "stop":b.after+="!trill)!"}};n.prototype.ntAbc=function(b,a,c,d){var f={"double-flat":-2,"flat-flat":-2,flat:-1,natural:0,sharp:1,"sharp-sharp":2,"double-sharp":2};a+=this.clefOct[this.curStf[d]]||0;var e=b;4<a&&(e=b.toLowerCase());5<a&&(e+=Array(a-5+1).join("'"));4>a&&(e+=Array(4-a+1).join(","));a=c.find("accidental").text();var g=c.find("pitch>alter").text();!g&&this.msralts[b]&&(g=0);var h=e+"#"+d;!g&&h in this.curalts&&
(g=0);if(""===a&&""===g)return e;if(""!=a)g=f[a];else{g=parseInt(g);if(h in this.curalts){if(g==this.curalts[h])return e}else if(g==(this.msralts[b]||0))return e;if(c.find("tie").map(function(){return $(this).attr("type")}).get().some(function(a){return"stop"==a}))return e;q("accidental %d added in part %d, measure %d, voice %d note %s",[g,this.msr.ixp+1,this.msr.ixm+1,d+1,e])}this.curalts[h]=g;return e=["__","_","=","^","^^"][g+2]+e};n.prototype.doNote=function(b){var a=new x(0,null),c=parseInt(b.find("voice").text()||
"1");this.isSib&&(c+=100*(b.find("staff").text()||1));var d=0<b.find("chord").length,f=b.find("pitch>step").text()||b.find("unpitched>display-step").text(),e=b.find("pitch>octave").text()||b.find("unpitched>display-octave").text(),g=0<b.find("rest").length,h=b.find("time-modification>actual-notes").text();if(h){var l=b.find("time-modification>normal-notes").text();a.fact=[parseInt(h),parseInt(l)]}a.tup=b.find("notations>tuplet").map(function(){return $(this).attr("type")}).get();l=b.find("duration").text();
h=b.find("grace");a.grace=0<h.length;a.before="";a.after="";a.grace&&!this.ingrace&&(this.ingrace=1,a.before="{","yes"==h.attr("slash")&&(a.before+="/"));if(h=!a.grace&&this.ingrace)this.ingrace=0,this.msc.lastnote.after+="}";if(g||"no"!=b.attr("print-object")){if(!l||a.grace)l=0;a.dur=parseInt(l);g||f&&e||(this.msc.cnt.inc("nopt",c),e=5,f="E");l=b.find("notations");l.length&&this.doNotations(a,l);g=g?"no"==b.attr("print-object")?"x":"z":this.ntAbc(f,parseInt(e),b,c);if(b.find("unpitched").length){var l=
this.curClef[this.curStf[c]],f=R(f,parseInt(e),l,this.tstep),e=b.find("instrument"),e=e.length?e.attr("id"):"dummyId",e=this.drumInst[e]||K(g),l=b.find("notehead"),k=l.text().replace(" ","-");"yes"==l.attr("filled")&&(k+="+");"x"==k&&(g="^"+g.replace(/\^/g,"").replace(/_/g,""));if("circle-x"==k||"diamond"==k)g="_"+g.replace(/\^/g,"").replace(/_/g,"");this.drumNotes[c+";"+g]=[f,e,k]}f=b.find("tie").map(function(){return $(this).attr("type")}).get();-1<f.indexOf("start")&&(g+="-");f=b.find("beam").map(function(){return $(this).text()}).get();
a.beam=-1<f.indexOf("continue")||-1<f.indexOf("end")||a.grace;f=b.find("lyric");for(e=l=0;e<f.length;++e){var k=$(f[e]),m=parseInt((k.attr("number")||"1").replace(/^.*verse/,""));0==m?m=l+1:l=m;a.lyrs[m]=W(k)}d?this.msc.addChord(g):(d=parseInt(b.find("staff").text()||"1"),this.curStf[c]!=d&&(f=d-this.curStf[c],this.curStf[c]=d,this.msc.appendElem(c,"[I:staff "+(0<f?"+":"")+f+"]")),this.msc.appendNote(c,a,g));f=b.find("notations>slur");for(e=0;e<f.length;++e)b=$(f[e]),this.matchSlur(b.attr("type"),
b.attr("number"),c,this.msc.lastnote,a.grace,h)}else this.msc.cnt.inc("nopr",c)};n.prototype.doAttr=function(b){var a,c,d,f,e,g,h,l,k,m,s,n;a={C1:"alto1",C2:"alto2",C3:"alto",C4:"tenor",F4:"bass",F3:"bass3",G2:"treble",TAB:"",percussion:"perc"};if(c=b.find("divisions").text())this.msr.divs=parseInt(c);c=parseInt(b.find("transpose>chromatic").text()||"0");d=b.find("key>fifths").first().text();f=0==this.msc.tijd&&0==this.msr.ixm;d&&(e=parseInt(d),g=b.find("key>mode").first().text()||"major",k="FCGDAEB".split(""),
l="Cb Gb Db Ab Eb Bb F C G D A E B F# C#".split(" "),h="Ab Eb Bb F C G D A E B F# C# G# D# A#".split(" "),d="","major"==g&&(d=l[7+e]),"minor"==g&&(d=h[7+e]+"min"),e=0<=e?z(k.slice(0,e),y(e,1)):z(k.slice(e),y(-e,-1)),e=[d,e],d=e[0],this.msralts=e[1],f&&!c&&"none"==p.key?p.key=d:d==p.key&&f||(this.msr.attr+="[K:"+d+"]"));if(d=b.find("time>beats").text())e=b.find("time>beat-type").text(),g=d+"/"+e,f?p.mtr=g:this.msr.attr+="[M:"+g+"]",this.msr.mdur=this.msr.divs*parseInt(d)*4/parseInt(e);(d=b.find("transpose>octave-change").text()||
"")&&(c+=12*parseInt(d));g=b.find("clef");for(e=0;e<g.length;e++)if(h=$(g[e]),d=parseInt(h.attr("number")||"1"),l=h.find("sign").text(),k="percussion"!=l?h.find("line").text()||"":"",k=a[l+k]||"",l=h.find("clef-octave-change").text()||"0",k+={"-2":"-15","-1":"-8",1:"+8",2:"+15"}[l]||"",this.clefOct[d]=-parseInt(l),c&&(k+=" transpose="+c),(l=b.find("staff-details>staff-lines").text())&&(k+=" stafflines="+l),this.curClef[d]=k,f)this.clefMap[d]=k;else for(h=this.stfMap[d],n=0;n<h.length;++n)m=h[n],d!=
this.curStf[m]&&(s=d-this.curStf[m],this.curStf[m]=d,l=0<s?"+":"",this.msc.appendElem(m,"[I:staff "+l+s+"]")),this.msc.appendElem(m,"[K:"+k+"]")};n.prototype.doDirection=function(b){var a,c,d,f,e,g,h,l,k;d=parseInt(b.find("staff").first().text()||"1");d=this.stfMap[d][0];a=b.attr("placement");c=b.find("sound");if(c.length){if(g=c.find("midi-instrument")){h=c.find("midi-instrument>midi-program").text();l=c.find("midi-instrument>midi-channel").text();for(k in this.vceInst)this.vceInst[k]==g.attr("id")&&
(d=k);(k=(h?h-1:l)+"")&&0<p.volpan&&this.msc.appendElem(d,"[I:MIDI= "+(h?"program":"channel")+" "+k+"]")}if(c=c.attr("tempo"))c=-1<c.indexOf(".")?parseFloat(c).toFixed(2):parseInt(c),0==this.msc.tijd&&0==this.msr.ixm?p.tempo=c:this.msc.appendElem(d,"[Q:1/4="+c+"]")}b=b.children("direction-type");if(b.length){c=b.find("wedge");if(c.length){switch(c.attr("type")){case "crescendo":f="!<(!";this.wedge_type="<";break;case "diminuendo":f="!>(!";this.wedge_type=">";break;case "stop":f="<"==this.wedge_type?
"!<)!":"!>)!";break;default:raise("wrong wedge type")}this.msc.appendElem(d,f)}f=b.find("words").eq(0);0==f.length&&(f=b.find("rehearsal").eq(0));f.length&&(a="below"==a?"_":"^",0>parseFloat(f.attr("default-y")||"0")&&(a="_"),(f=f.text().replace(/"/g,'\\"').replace(/\n/g," ").trim())&&this.msc.appendElem(d,'"'+a+f+'"',1));for(e in P)a=P[e],b.find("dynamics>"+e).length&&this.msc.appendElem(d,a,1);b.find("coda").length&&this.msc.appendElem(d,"O",1);b.find("segno").length&&this.msc.appendElem(d,"S",
1)}};n.prototype.doHarmony=function(b){var a,c,d,f,e,g,h,l,k;a=parseInt(b.children("staff").text()||"1");a=this.stfMap[a][0];c={major:"",minor:"m",augmented:"+",diminished:"dim",dominant:"7","half-diminished":"m7b5"};d={major:"maj",dominant:"",minor:"m",diminished:"dim",augmented:"+",suspended:"sus"};f={second:"2",fourth:"4",seventh:"7",sixth:"6",ninth:"9","11th":"11","13th":"13"};e={1:"#",0:"","-1":"b"};g=b.find("root>root-step","").text();h=e[b.find("root>root-alter").text()]||"";l="";k=b.find("kind").text();
k in c?k=c[k]:-1<k.indexOf("-")?(c=k.split("-"),k=c[0],c=c[1],k=(d[k]||"")+(f[c]||""),0==k.indexOf("sus")&&(l=k,k="")):"none"==k&&(k=b.find("kind").attr("text"));d=b.find("degree");for(f=0;f<d.length;++f)c=$(d[f]),k+=(e[c.find("degree-alter").text()]||"")+c.find("degree-value").text();k=k.replace("79","9").replace("713","13").replace("maj6","6");b=b.find("bass>bass-step").text()+(e[b.find("bass>bass-alter").text()]||"");this.msc.appendElem(a,'"'+g+h+k+l+(b&&"/"+b)+'"',1)};n.prototype.doBarline=function(b){var a=
b.find("repeat"),c=0;a.length&&(c=a.attr("direction"));if(this.unfold)return c?"forward"==c?1:2:0;"right"==b.attr("location")&&(a=b.find("bar-style").text(),"light-light"==a?this.msr.rline="||":"light-heavy"==a&&(this.msr.rline="|]"));c&&("forward"==c?this.msr.lline=":":this.msr.rline=":|");b=b.find("ending");b.length&&("start"==b.attr("type")?(b=(b.attr("number")||"1").replace(/\./g,"").replace(/ /g,""),/^[\d,]+$/.test(b)||(b='"'+b.trim()+'"'),this.msr.lnum=b):"|"==this.msr.rline&&(this.msr.rline=
"||"));return 0};n.prototype.doPrint=function(b){if("yes"==b.attr("new-system")||"yes"==b.attr("new-page"))return this.nolbrk?"":"$"};n.prototype.doPartList=function(b){var a,c,d,f,e,g,h,l,k,m;f=b.find("part-list>score-part");for(a=0;a<f.length;++a){c=f[a];e={};g=$(c).find("midi-instrument");for(c=0;c<g.length;++c){h=$(g[c]);k=["midi-channel","midi-program","volume","pan"];l=[];for(d=0;d<k.length;++d)m=k[d],l.push(h.find(m).text()||this.midDflt[d]);d=l[3];-90<=d&&90>=d&&(d=(d+90)/180*127);e[h.attr("id")]=
[parseInt(l[0]),parseInt(l[1]),parseFloat(l[2]),d];(l=h.find("midi-unpitched").text())&&(this.drumInst[h.attr("id")]=l-1)}this.instMid.push(e)}b=b.find("part-list");l=V(b);return F(l,{},[])[0]};n.prototype.mkTitle=function(b){var a,c,d=[],f=[],e=[],g,h,l,k,m;a=b.find("work>work-title").text().trim();c=b.find("movement-title").text().trim();g=b.find("identification>creator");for(h=0;h<g.length;++h)l=$(g[h]),k=l.text(),l=l.attr("type"),k&&(k=k.split("\n").map(function(a){return a.trim()}),"composer"==
l?d.push.apply(d,k):"lyricist"!=l&&"transcriber"!=l||f.push.apply(f,k));g=b.find("identification>rights");for(h=0;h<g.length;++h)k=$(g[h]).text(),k=k.split("\n").map(function(a){return a.trim()}),f.push.apply(f,k);g=b.find("credit");for(h=0;h<g.length;++h){k="";l=$(g[h]).find("credit-words");for(m=0;m<l.length;++m)k+=$(l[m]).text();e.push(k.replace(/\s*[\r\n]\s*/g," "))}e=function(b){function g(a){return a&&-1<h.indexOf(a)}var l=[],h,k;for(k=0;k<e.length;++k)h=e[k],6>b&&(h&&-1<a.indexOf(h)||h&&-1<
c.indexOf(h))||5>b&&(h&&-1<d.indexOf(h)||h&&-1<f.indexOf(h))||4>b&&(a&&-1<h.indexOf(a)||c&&-1<h.indexOf(c))||3>b&&(d.some(g)||f.some(g))||2>b&&/^[\d\W]*$/.test(h)||l.push(h);0==b&&a+c&&(l="");return l}(this.ctf);a&&(a="T:"+a.replace(/\n/g,"\nT:")+"\n");c&&(a+="T:"+c.replace(/\n/g,"\nT:")+"\n");e.length&&(a+=e.map(function(a){return"T:"+a}).join("\n")+"\n");d.length&&(a+=d.map(function(a){return"C:"+a}).join("\n")+"\n");f.length&&(a+=f.map(function(a){return"Z:"+a}).join("\n")+"\n");a&&(p.title=a.substr(0,
a.length-1));(this.isSib=0<=b.find("identification>encoding>software").text().indexOf("Sibelius"))&&q("Sibelius MusicXMl is unreliable",[])};n.prototype.doDefaults=function(b){var a,c,d,f;this.doPageFmt&&(a=b.find("defaults"),a.length&&(b=a.find("scaling>millimeters").text(),c=a.find("scaling>tenths").text(),c=b/c/10,b=a.find("page-layout>page-width").text()*c,d=a.find("page-layout>page-margins").first(),a=d.find("left-margin").text(),d=d.find("right-margin").text(),f=10*c/.2117,!p.scale&&f&&(p.scale=
f.toFixed(2)),!p.pagewidth&&b&&(p.pagewidth=b.toFixed(2)),p.leftmargin||""==a||(p.leftmargin=(a*c).toFixed(2)),p.rightmargin||""==d||(p.rightmargin=(d*c).toFixed(2))))};n.prototype.locStaffMap=function(b){var a={};this.vceInst={};this.msc.vnums={};b=b.find("measure>note");for(var c=0;c<b.length;c++){var d=$(b[c]),f=parseInt(d.find("voice").text()||"1");this.isSib&&(f+=100*(d.find("staff").text()||1));this.msc.vnums[f]=1;var e=parseInt(d.find("staff").text()||"1");if(f in a){var g=a[f];g[e]=(g[e]||
0)+1}else g={},g[e]=1,a[f]=g;g=d.find("instrument");g.length&&(this.vceInst[f]=$(g).attr("id"))}this.stfMap={};this.clefMap={};for(f in a){b=[];c=a[f];for(e in c)b.push([c[e],e]);b.sort(function(a,b){return b[0]-a[0]});b=b[0][1];this.stfMap[b]=(this.stfMap[b]||[]).concat([f]);this.curStf[f]=b}};n.prototype.addStaffMap=function(b){var a,c,d,f,e,g,h=[],l=Object.keys(this.stfMap).sort();for(c=0;c<l.length;++c){e=l[c];f=this.stfMap[e];g=[];for(a=0;a<f.length;++a)d=f[a],d in b&&g.push(b[d]);if(g.length)for(h.push(g.sort()),
f=(e in this.clefMap)?this.clefMap[e]:"treble",a=0;a<g.length;++a)d=g[a],p.clefs[d]=f}this.gStfMap.push(h)};n.prototype.addMidiMap=function(b,a){var c=this.instMid[b],d,f=Object.keys(c);d=f.length?c[f[0]]:this.midDflt;var e=[],g,h,l,k=this;for(g in a)f=Object.keys(this.drumNotes).sort().filter(function(a){return a.split(";")[0]==g}),l=f.map(function(a){return{nt:a.split(";")[1],step:k.drumNotes[a][0],midi:k.drumNotes[a][1],nhd:k.drumNotes[a][2]}}),f=a[g],h=this.vceInst[g]||"",h in c?e.push([f,c[h].concat(l)]):
e.push([f,d.concat(l)]);e.sort(function(a,b){return a[0]-b[0]});for(c=0;c<e.length;++c)f=e[c][0],d=e[c][1],this.midiMap.push(d)};n.prototype.parse=function(b){var a=$(b);this.mkTitle(a);this.doDefaults(a);partlist=this.doPartList(a);b=a.find("part");for(var c=0;c<b.length;++c){var a=$(b[c]),d=a.find("measure");this.locStaffMap(a);this.drumNotes={};this.clefOct={};this.msc.initVoices(1);var f=0,e=0;for(this.msr=new I(c);this.msr.ixm<d.length;){var g=$(d[this.msr.ixm]),h=0,l="";this.msr.reset();this.curalts=
{};for(var k=g.children(),m=0;m<k.length;m++){var n=k[m],a=$(n);switch(n.nodeName){case "note":this.doNote(a);break;case "attributes":this.doAttr(a);break;case "direction":this.doDirection(a);break;case "sound":this.doDirection(g);break;case "harmony":this.doHarmony(a);break;case "barline":h=this.doBarline(a);break;case "backup":a=parseInt(a.find("duration").text());this.msc.incTime(-a);break;case "forward":a=parseInt(a.find("duration").text());this.msc.incTime(a);break;case "print":l=this.doPrint(a)}}this.msc.addBar(l,
this.msr);1==h?(e=this.msr.ixm,this.msr.ixm+=1):2==h?1>f?(this.msr.ixm=e,f+=1):(f=0,this.msr.ixm+=1):this.msr.ixm+=1}d=this.msc.outVoices(this.msr.divs,c);this.addStaffMap(d);this.addMidiMap(c,d)}Object.keys(d).length?p.mkHeader(this.gStfMap,partlist,this.midiMap):q("nothing written, %s has no notes ...",[p.fnmext])};vertaal=function(b,a){var c={u:0,b:0,n:0,c:0,v:0,d:0,m:0,x:0,t:0,p:"f"},d;for(d in a)c[d]=a[d];c.p=c.p?c.p.split(","):[];p=new E(".abc","",0,c);c=new n(c);try{c.parse(b)}catch(f){q("** exception occurred: %s",
[f])}return[p.outlist.join(""),p.infolist.join("\n")]}})();
