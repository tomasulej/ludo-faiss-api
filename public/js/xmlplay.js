//~ Revision: 81, Copyright (C) 2016-2018: Willem Vree, contributions St√©phane David.
//~ This program is free software; you can redistribute it and/or modify it under the terms of the
//~ GNU General Public License as published by the Free Software Foundation; either version 2 of
//~ the License, or (at your option) any later version.
//~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
//~ without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
//~ See the GNU General Public License for more details. <http://www.gnu.org/licenses/gpl.html>.
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,e,m){if(m.get||m.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[e]=m.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var e=0;return $jscomp.iteratorPrototype(function(){return e<b.length?{done:!1,value:b[e++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,e){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var m=0,d={next:function(){if(m<b.length){var u=m++;return{value:e(u,b[u]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(b,e,m,d){if(e){m=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var u=b[d];u in m||(m[u]={});m=m[u]}b=b[b.length-1];d=m[b];e=e(d);e!=d&&null!=e&&$jscomp.defineProperty(m,b,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6-impl","es3");
$jscomp.polyfill("Math.log10",function(b){return b?b:function(b){return Math.log(b)/Math.LN10}},"es6-impl","es3");$jscomp.makeIterator=function(b){$jscomp.initSymbolIterator();var e=b[Symbol.iterator];return e?e.call(b):$jscomp.arrayIterator(b)};$jscomp.EXPOSE_ASYNC_EXECUTOR=!0;$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(b){function e(){this.batch_=null}if(b&&!$jscomp.FORCE_POLYFILL_PROMISE)return b;e.prototype.asyncExecute=function(b){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(b);return this};e.prototype.asyncExecuteBatch_=function(){var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})};var m=$jscomp.global.setTimeout;e.prototype.asyncExecuteFunction=function(b){m(b,0)};e.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var b=
this.batch_;this.batch_=[];for(var E=0;E<b.length;++E){var d=b[E];delete b[E];try{d()}catch(A){this.asyncThrow_(A)}}}this.batch_=null};e.prototype.asyncThrow_=function(b){this.asyncExecuteFunction(function(){throw b;})};var d=function(b){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var p=this.createResolveAndReject_();try{b(p.resolve,p.reject)}catch(Q){p.reject(Q)}};d.prototype.createResolveAndReject_=function(){function b(b){return function(p){e||(e=!0,b.call(d,p))}}var d=this,e=
!1;return{resolve:b(this.resolveTo_),reject:b(this.reject_)}};d.prototype.resolveTo_=function(b){if(b===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(b instanceof d)this.settleSameAsPromise_(b);else{var p;a:switch(typeof b){case "object":p=null!=b;break a;case "function":p=!0;break a;default:p=!1}p?this.resolveToNonPromiseObj_(b):this.fulfill_(b)}};d.prototype.resolveToNonPromiseObj_=function(b){var d=void 0;try{d=b.then}catch(Q){this.reject_(Q);return}"function"==
typeof d?this.settleSameAsThenable_(d,b):this.fulfill_(b)};d.prototype.reject_=function(b){this.settle_(2,b)};d.prototype.fulfill_=function(b){this.settle_(1,b)};d.prototype.settle_=function(b,d){if(0!=this.state_)throw Error("Cannot settle("+b+", "+d|"): Promise already settled in state"+this.state_);this.state_=b;this.result_=d;this.executeOnSettledCallbacks_()};d.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var b=this.onSettledCallbacks_,d=0;d<b.length;++d)b[d].call(),
b[d]=null;this.onSettledCallbacks_=null}};var u=new e;d.prototype.settleSameAsPromise_=function(b){var d=this.createResolveAndReject_();b.callWhenSettled_(d.resolve,d.reject)};d.prototype.settleSameAsThenable_=function(b,d){var e=this.createResolveAndReject_();try{b.call(d,e.resolve,e.reject)}catch(A){e.reject(A)}};d.prototype.then=function(b,e){function p(b,d){return"function"==typeof b?function(d){try{A(b(d))}catch(T){m(T)}}:d}var A,m,E=new d(function(b,d){A=b;m=d});this.callWhenSettled_(p(b,A),
p(e,m));return E};d.prototype["catch"]=function(b){return this.then(void 0,b)};d.prototype.callWhenSettled_=function(b,d){function e(){switch(p.state_){case 1:b(p.result_);break;case 2:d(p.result_);break;default:throw Error("Unexpected state: "+p.state_);}}var p=this;null==this.onSettledCallbacks_?u.asyncExecute(e):this.onSettledCallbacks_.push(function(){u.asyncExecute(e)})};d.resolve=function(b){return b instanceof d?b:new d(function(d,e){d(b)})};d.reject=function(b){return new d(function(d,e){e(b)})};
d.race=function(b){return new d(function(e,m){for(var p=$jscomp.makeIterator(b),u=p.next();!u.done;u=p.next())d.resolve(u.value).callWhenSettled_(e,m)})};d.all=function(b){var e=$jscomp.makeIterator(b),m=e.next();return m.done?d.resolve([]):new d(function(b,p){function u(d){return function(e){A[d]=e;E--;0==E&&b(A)}}var A=[],E=0;do A.push(void 0),E++,d.resolve(m.value).callWhenSettled_(u(A.length-1),p),m=e.next();while(!m.done)})};$jscomp.EXPOSE_ASYNC_EXECUTOR&&(d.$jscomp$new$AsyncExecutor=function(){return new e});
return d},"es6-impl","es3");var xmlplay_VERSION=81,instUrl="",instTab={};
(function(){function b(a){F.innerHTML+=a+"\n"}function e(a){var n=a.slice(0,4E3);0<=n.indexOf("X:")?p(a):-1==n.indexOf("<?xml ")?alert("not an xml file nor an abc file"):(a=(new window.DOMParser).parseFromString(a,"text/xml"),n={p:"f",t:1,u:0,v:3,m:2},Ga&&(n.p=""),Ha&&(n.x=1),a=vertaal(a,n),a[1]&&b(a[1]),p(a[0]))}function m(){var a,b=new FileReader;b.onload=function(a){e(b.result)};if(a=ha?ha[0]:V.files[0])ia=a.name.split(".")[0],b.readAsText(a)}function d(a){F.innerHTML="";var n=a[0].link;ia=a[0].name.split(".")[0];
q.style.display="block";b("link: "+n+"<br>");var c=new XMLHttpRequest;c.open("GET",n,!0);c.onload=function(){b("XHR ok");q.style.display="none";e(c.responseText)};c.onerror=function(){q.innerHTML+="XHR failed<br>"};c.send()}function u(a){a.stopPropagation();a.preventDefault();ha=a.dataTransfer.files;this.classList.remove("indrag");m()}function p(a){function b(a){var b,c,l,f,g,n,G={},d,k={},B=[18,20,22,24,26,28];a=a.split("\n");for(b=0;b<a.length;++b)if(c=a[b],0<=c.indexOf("strings")&&(l=c.match(/V:\s*(\S+).*strings\s*=\s*(\S+)/)))d=
l[1],G[d]={},l[2].split(",").forEach(function(a,b){f=a[0];g=12*parseInt(a[1]);n=g+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(f)]+12;G[d][B[b]]=n}),k[d]=0<=c.indexOf("diafret");return[G,k]}function c(a){var b,c,l,f,g={};a=a.split("\n");for(b=0;b<a.length;++b)if(c=a[b],0<=c.indexOf("%%map")&&(l=c.match(/%%map *(\S+) *(\S+).*midi=(\d+)/)))c=l[1],f=l[2],l=l[3],g[c+f]=parseInt(l);return g}function d(a){var b={diamond:1,triangle:1,square:1,normal:1},c=['%%beginsvg\n<defs>\n<text id="x" x="-3" y="0">&#xe263;</text>\n<text id="x-" x="-3" y="0">&#xe263;</text>\n<text id="x+" x="-3" y="0">&#xe263;</text>\n<text id="normal" x="-3.7" y="0">&#xe0a3;</text>\n<text id="normal-" x="-3.7" y="0">&#xe0a3;</text>\n<text id="normal+" x="-3.7" y="0">&#xe0a4;</text>\n<g id="circle-x"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"/></g>\n<g id="circle-x-"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"/></g>\n<path id="triangle" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"/>\n<path id="triangle-" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"/>\n<path id="triangle+" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="fill:#000"/>\n<path id="square" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="square-" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="square+" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="fill:#000"/>\n<path id="diamond" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="diamond-" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"/>\n<path id="diamond+" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="fill:#000"/>\n</defs>\n%%endsvg'],
l,f,g,n="default",d={"default":[]};a=a.split("\n");for(l=0;l<a.length;++l)if(f=a[l],0<=f.indexOf("I:percmap")&&(f=f.split(" "),g=f[4],g in b&&(g=g+"+,"+g),f="%%map perc"+n+" "+f[1]+" print="+f[2]+" midi="+f[3]+" heads="+g,d[n].push(f)),0<=f.indexOf("V:")&&(g=f.match(/V:\s*(\S+)/)))n=g[1],n in d||(d[n]=[]);for(n in d)c=c.concat(d[n]);for(l=0;l<a.length;++l)f=a[l],0<=f.indexOf("I:percmap")||(0<=f.indexOf("V:")||0<=f.indexOf("K:")?((g=f.match(/V:\s*(\S+)/))&&(n=g[1]),0==d[n].length&&(n="default"),c.push(f),
0<=f.indexOf("perc")&&-1==f.indexOf("map=")&&(f+=" map=perc"),0<=f.indexOf("map=perc")&&0<d[n].length&&c.push("%%voicemap perc"+n),0<=f.indexOf("map=off")&&c.push("%%voicemap")):c.push(f));return c.join("\n")}a=a.split("\n");a.splice(1,0,"%%measurenb 0");a=a.join("\n");0<=a.indexOf("I:percmap")&&(a=d(a));0<=a.indexOf("%%map")&&(Ia=c(a));0<=a.indexOf(" strings")&&b(a);ja=a;E(a);Q(a)}function E(a){function n(a){var b=[];a.forEach(function(a,c){b[a.st]?b[a.st].push(c):b[a.st]=[c];a.clef.clef_octave&&
(W[c]=a.clef.clef_octave);Ja[a.st]=6*(a.stafflines||"|||||").length*(a.staffscale||1);J[c]=a.midictl&&a.midictl[7];void 0==J[c]&&(J[c]=100);K[c]=a.midictl&&a.midictl[10];void 0==K[c]&&(K[c]=64)});return b}var c,d="",k=[3,0,4,1,5,2,6],h=[0,2,4,5,7,9,11];L=[];W=[];M.value=N=O=120;J=[];K=[];c=new Abc({img_out:null,errmsg:function(a,b,c){d+=a+"\n"},read_file:function(a){return""},anno_start:null,get_abcmodel:function(b,c,d){function g(a,c){f[a]=[0,0,0,0,0,0,0];l[a]={};B[a]=c;var b=0<=c;(b?k.slice(0,c):
k.slice(c)).forEach(function(c){f[a][c]+=b?1:-1})}var f={},G={"-2":-2,"-1":-1,0:0,1:1,2:2,3:0},l={},B={},x={};d=c[0].meter.a_meter;d.length&&parseInt(d[0].top);for(y=0;y<c.length;++y)g(y,c[y].key.k_sf),x[y]={};d={};Ka=c.length;n(c);for(c=b;c;c=c.ts_next){var e,w,m,t,p=[],y;switch(c.type){case 14:b=c.tempo_notes.reduce(function(a,c){return a+c});O=c.tempo*b/384;0==c.time&&(M.value=N=O);break;case 10:m={t:c.time,mnum:-1,dur:c.dur};p.push(m);L.push({t:c.time,ix:c.istart,v:c.v,ns:p,inv:c.invis,tmp:O});
break;case 8:var r=c.p_v.instr;"p"==c.p_v.clef.clef_type&&(r=119);r||(r=0);for(b=0;b<c.notes.length;++b){e=c.notes[b];w=e.pit+19;y=c.v;W[y]&&(w+=W[y]);m=Math.floor(w/7);t=w%7;void 0!=e.acc&&(l[y][w]=G[e.acc]);m=12*m+h[t]+(w in l[y]?l[y][w]:f[y][t]);t=c.p_v.map;if(119==r&&"MIDIdrum"!=t){var q=a.substring(c.istart,c.iend),q=q.match(/[=_^]*[A-Ga-g]/)[0];(t=Ia[t+q])&&(m=t)}m=128*r+m;d[m]=1;m={t:c.time,mnum:m,dur:c.dur};w in x[y]?(x[y][w].dur+=c.dur,0==e.ti1&&delete x[y][w]):(0!=e.ti1&&(x[y][w]=m),p.push(m))}if(0==
p.length)break;L.push({t:c.time,ix:c.istart,v:c.v,ns:p,stf:c.st,tmp:O});break;case 5:g(c.v,c.k_sf);break;case 0:g(c.v,B[c.v]),L.push({t:c.time,ix:c.istart,v:c.v,bt:c.bar_type,tx:c.text})}}ka.forEach(function(a){var c=a.parentNode;c&&c.removeChild(a)});X=[];G="#f9f #3cf #c99 #f66 #fc0 #cc0 #ccc".split(" ");for(b=0;b<Ka;++b)x=1<<b&la?"0":"",y=document.createElementNS("http://www.w3.org/2000/svg","rect"),y.setAttribute("fill",G[b%G.length]+x),y.setAttribute("fill-opacity","0.5"),y.setAttribute("width",
"0"),ka.push(y),X.push(-1);null!=v?bb(d):alert("Your browser has no Web Audio API -> no playback.")}});c.tosvg("play","%%play");c.tosvg("abc2svg",a);""==d&&(d="no error");b(d)}function Q(a){function n(a){var c,b,d,n,f;a.stopPropagation();d=a.clientX;d-=this.getBoundingClientRect().left;n=d*Y;if(n<g+24||n>e)Z();else{d=r.getBoundingClientRect().top-r.scrollTop;f=H.indexOf(this);b=(a.clientY-d-ma[f])*Y;d=aa[f];for(a=0;a<d.length;a++)if(d[a]>b){na=a;U(f);break}for(a=0;a<z.length;++a)if(c=z[a].xy)if(b=
c[0],d=c[1],c=c[3],!(b<f)&&n<parseFloat(d)+c){C=a;for(n=z[a].t;z[a]&&z[a].t==n;)ga(z[a]),a+=1;break}}}var c,d="",k="",h=0;C=0;oa={};aa=[];var x={},l,f,g=1E3,e=0;na=0;a&&(c=new Abc({imagesize:'width="100%"',img_out:function(a){-1!=a.indexOf("<svg")&&(aa[h]=Object.keys(x),x={},h+=1,l<g&&(g=l),f>e&&(e=f));d+=a},errmsg:function(a,c,b){k+=a+"\n"},read_file:function(a){return""},anno_start:function(a,b,d,n,g,k,B){if("note"==a||"rest"==a)n=c.ax(n).toFixed(2),g=c.ay(g).toFixed(2),B=c.ah(B),oa[b]=[h,n,g,k,
B];"bar"==a&&(g=c.ay(g),B=c.ah(B),g=Math.round(g+B),x[g]=1,f=c.ax(n),l=c.ax(0))},get_abcmodel:null}),c.tosvg("abc2svg",a),""==k&&(k="no error\n"),b(k),d&&(r.innerHTML='<div id="leeg" style="height:'+pa+'px">&nbsp;</div>',r.innerHTML+=d,r.innerHTML+='<div id="leeg" style="height:'+pa+'px">&nbsp;</div>',ba(document.getElementById("leeg"),"click",Z),H=Array.prototype.slice.call(r.getElementsByTagName("svg")),a=Array.prototype.slice.call(r.getElementsByClassName("g")),qa=a.length?a:H,A(),Ea(),H.forEach(function(a){cb&&
(a.style.display="none");ba(a,"click",n)}),ab()))}function A(){if(0!=H.length){var a=r.getBoundingClientRect().top-r.scrollTop;ma=H.map(function(b){return b.getBoundingClientRect().top-a})}}function Ea(){if(0!=H.length){var a,b,c,d=H[0];a=d.getBoundingClientRect().width;try{b=d.viewBox.baseVal.width}catch(k){b=a}c=(c=qa[0].transform)?c.baseVal:[];c=c.numberOfItems?c.getItem(0).matrix.a:1;Y=b/c/a}}function U(a){void 0==a&&(a=La);var b=P.getBoundingClientRect().top,c=r.getBoundingClientRect().top,d=
na;r.scrollTop=ma[a]+(aa[a][d]-Ja[d])/Y-(b+30-c);La=a}function Fa(a){function b(a){r.getBoundingClientRect();k.style.top=(d?a.touches[0].clientY:a.clientY)-15+"px";U()}function c(a){k.removeEventListener("mousemove",b);k.removeEventListener("touchmove",b);k.removeEventListener("mouseup",c);k.removeEventListener("touchend",c);k.removeEventListener("mouseleave",c);k.style.cursor="";k.classList.remove("spel")}a.preventDefault();var d="touchstart"==a.type,k=P;k.style.cursor="row-resize";k.classList.add("spel");
k.addEventListener("mousemove",b);k.addEventListener("touchmove",b);k.addEventListener("mouseup",c);k.addEventListener("touchend",c);k.addEventListener("mouseleave",c)}function ga(a){var b,c,d,k,h,x,l;x=ka[a.vce];(b=a.xy)?(c=b[0],d=b[1],k=b[2],h=b[3],b=b[4],a.inv&&(b=h=0),c!=X[a.vce]&&((l=x.parentNode)&&l.removeChild(x),l=qa[c],l.insertBefore(x,l.firstChild),X[a.vce]=c,U(c)),x.setAttribute("x",d),x.setAttribute("y",k),x.setAttribute("width",h),x.setAttribute("height",b)):(x.setAttribute("width",0),
x.setAttribute("height",0))}function ab(){var a=0<C?z[C].t:0;z=[];ra={};var b=1,c=0,d=0,k=0,h=0,x=0,l,f;for(l=0;l<L.length;++l){f=L[l];if(f.bt&&0==f.v){if(f.t in ra)continue;if(1==b&&":"==f.bt[0]&&f.t>k){l=d-1;b=2;c+=f.t-k;continue}2==b&&":"==f.bt[0]&&f.t>k&&(b=1);1==b&&":"==f.bt[f.bt.length-1]&&(d=l,k=f.t);h&&(f.tx||"|"!=f.bt)&&(h=0,c-=f.t-x);2==b&&"1"==f.tx&&(h=1,x=f.t)}h||(f.bt?ra[f.t]=1:z.push({t:f.t+c,xy:oa[f.ix],ns:f.ns,vce:f.v,inv:f.inv,tmp:f.tmp}))}for(C=0;C<z.length&&(f=z[C],!(f.t>=a)||f.inv);++C);
C==z.length&&--C;ga(z[C])}function T(){if(v){for(var a=1E3*v.currentTime,b=0,c;0==b;){var d=z[C];d.tmp!=N&&(N=d.tmp,M.value=Math.round(N*sa));c=156.25/(d.tmp*sa);C==z.length-1?(C=-1,b=d.ns[0].dur+1E3):(b=z[C+1].t,b=(b-d.t)*c);d.ns.forEach(function(b,n){c=192>=b.dur?1.3*c:1.1*c;var h=b.mnum,l=b.dur*c,f=d.vce;if(-1!=h){var g=h>>7;if(g in ta){var k=h%128,h=a/1E3,l=(l-1)/1E3,e,B,m,p,r,w,q,t=ua[g][k],u=v.createBufferSource(),y=t.useflt,z=t.uselfo,C=t.useenv;e=J[f]/127;f=(K[f]-64)/64;u.buffer=t.buffer;
t.loopStart&&(u.loop=!0,u.loopStart=t.loopStart,u.loopEnd=t.loopEnd);u.playbackRate.value=va[g][k];z&&(m=v.createOscillator(),m.frequency.value=t.lfofreq,g=v.createGain(),g.gain.value=t.lfo2vol,m.connect(g),B=v.createGain(),B.gain.value=1,g.connect(B.gain),g=v.createGain(),g.gain.value=t.lfo2ptc,m.connect(g),g.connect(u.detune));if(y){var A=v.createBiquadFilter();A.type="lowpass";A.frequency.value=t.filter}if(C){var D=1,g=v.createGain();g.gain.setValueAtTime(0,h);g.gain.linearRampToValueAtTime(D,
h+t.envatt);k=t.envhld;w=t.envdec;l>k&&(g.gain.setValueAtTime(D,h+k),l<w?(q=l-k,w=q/(w-k)*t.envsus):(q=w-k,w=t.envsus),D*=w,g.gain.linearRampToValueAtTime(D,h+k+q));g.gain.setValueAtTime(D,h+l);k=h+l+D*t.envrel;g.gain.linearRampToValueAtTime(0,k);p=v.createConstantSource();p.offset.value=t.env2flt;p.connect(g);g.connect(A.detune)}ca&&(r=v.createStereoPanner(),r.pan.value=f);D=e*t.atten*.5;0==D&&(D=1E-5);e=v.createGain();e.gain.setValueAtTime(1E-5,h);e.gain.exponentialRampToValueAtTime(D,h+t.attack);
k=t.hold;w=t.decay;l>k&&(e.gain.setValueAtTime(D,h+k),l<w?(q=l-k,w=Math.pow(10,q/(w-k)*Math.log10(t.sustain))):(q=w-k,w=t.sustain),D*=w,e.gain.exponentialRampToValueAtTime(D,h+k+q));e.gain.setValueAtTime(D,h+l);k=h+l+(100+20*Math.log10(D))/100*t.release;e.gain.exponentialRampToValueAtTime(1E-5,k);y?(u.connect(A),A.connect(r||e)):u.connect(r||e);r&&r.connect(e);z?(e.connect(B),B.connect(v.destination)):e.connect(v.destination);u.start(h);z&&m.start(h+t.lfodel);C&&p.start(h);u.stop(k);z&&m.stop(k);
C&&p.stop(k)}else B=[144,h,100],Ma(B,a,f),B[2]=0,Ma(B,a+l-1,f)}});ga(d);C+=1}clearTimeout(wa);wa=setTimeout(T,b)}else alert("Your browser has no Web Audio API -> no playback.")}function Z(){z.length&&((Na=1-Na)?(da.value="Stop",ea.style.display="none",T()):(da.value="Play",clearTimeout(wa)))}function db(){sa=M.value/N}function Ma(a,b,c){if(0!=Oa){var d=a[0]&240,k=a[2];a=a[1];b/=1E3;128==d&&Pa(a,b);if(144==d)if(0<k){d=k;k=J[c]/127;c=(K[c]-64)/64;var h,n=v.createBufferSource();n.buffer=Qa[a];var l=
v.createGain();l.gain.setValueAtTime(1E-5,b);d=d*k*.015625;0==d&&(d=1E-5);l.gain.exponentialRampToValueAtTime(d,b+.001);ca&&(h=v.createStereoPanner(),h.pan.value=c);n.connect(h||l);h&&h.connect(l);l.connect(v.destination);n.start(b);xa[a]=[n,l,d]}else Pa(a,b)}}function Pa(a,b){var c=xa[a],d=c[0],k=c[1],c=c[2];d&&(k.gain.setValueAtTime(c,b),k.gain.exponentialRampToValueAtTime(1E-5,b+.1),d.stop(b+.1),xa[a]=void 0)}function Ra(a){return new Promise(function(b,c){for(var d=atob(a),k=new ArrayBuffer(d.length),
h=new Uint8Array(k),e=0;e<d.length;e++)h[e]=d.charCodeAt(e);v.decodeAudioData(k,function(a){b(a)},function(a){c({err:1,msg:a,data:""})})})}function eb(a){return new Promise(function(b,c){function d(k){var h,e,n,f;h=instData[k];e={attack:h.attack,hold:h.hold,decay:h.decay,sustain:h.sustain,release:h.release,atten:h.atten,filter:h.filter,lfodel:h.lfodel,lfofreq:h.lfofreq,lfo2ptc:h.lfo2ptc,lfo2vol:h.lfo2vol,envatt:h.envatt,envhld:h.envhld,envdec:h.envdec,envsus:h.envsus,envrel:h.envrel,env2flt:h.env2flt,
uselfo:ya&&.008<h.lfofreq&&(0!=h.lfo2ptc||0!=h.lfo2vol),useflt:za&&16E3>h.filter,useenv:Aa&&16E3>h.filter&&0!=h.env2flt};h.loopStart&&(e.loopStart=h.loopStart,e.loopEnd=h.loopEnd);n=h.scale;f=h.tune;for(var g=h.keyRangeLo;g<=h.keyRangeHi;g++)va[a][g]=Math.pow(Math.pow(2,1/12),(g+f)*n),ua[a][g]=e,Ba[128*a+g]=1;Ra(h.sample).then(function(a){e.buffer=a;k<instData.length-1?d(k+1):(instData="",b("ok"))})["catch"](function(a){c(a)})}va[a]=[];ua[a]=[];d(1)})}function fb(a){return new Promise(function(b,
c){var d=document.createElement("script");d.src=instUrl+"instr"+a+"mp3.js";d.onload=function(){b("ok");document.head.removeChild(d)};d.onerror=function(b){c({err:2,msg:"could not load "+d.src,data:a})};document.head.appendChild(d)})}function Sa(a){void 0==a.err&&(a.err=4,a.msg=a.toString());b(a.err+", "+a.msg+", "+a.data);switch(a.err){case 1:alert("Your browser does not support decoding ogg/vorbis -> no playback");break;case 2:a="Loading javascript soundfont failed, instrument "+a.data+"\nfalling back to midi-js";
b(a);q.innerHTML+=a.replace("\n","<br>");break;case 3:b("Loading midi-js soundfont failed, instrument "+a.data+"\nmsg: "+a.msg);break;case 4:alert(a.msg)}}function fa(a){function d(a){return new Promise(function(c,d){if(Ca[a])c("ok");else{var f;Ta[a]?f="https://rawgit.com/gleitz/midi-js-soundfonts/gh-pages/FluidR3_GM/"+g+"-mp3":(g=a in instTab?instTab[a]:g,f=instUrl+g+"-mp3");q.innerHTML+=", loading: "+a;var e=document.createElement("script");e.src=f+".js";e.onload=function(){Ca[a]=MIDI.Soundfont[g];
Ua[f]=1;b("midi-js instr "+h+" geladen");c("ok")};e.onerror=function(){d({err:3,msg:"could not load:"+f,data:a})};f in Ua?c("ok"):document.head.appendChild(e)}})}function c(b){d(b).then(function(){var a=Ca[b][l+f].split(",")[1];return Ra(a)}).then(function(c){Qa[k]=c;q.innerHTML+=", "+b+":"+m;Ba[k]=1;fa(a)})["catch"](function(a){Sa(a);-1==a.msg.indexOf("gleitz")?(Ta[b]=1,q.innerHTML+="<br>loading local midi-js font failed, instrument: "+a.data+"<br>trying Github ...",c(b)):(alert("loading soundfont from Github failed, giving up."),
q.style.display="none")})}var e="C Db D Eb E F Gb G Ab A Bb B".split(" "),k=a.shift();if(k){var h=k>>7,m=k%128,l=e[m%12],f=Math.floor(m/12)-1,g=gb[h];ta[h]?fa(a):R&&!Va[h]?fb(h).then(function(){q.innerHTML+="loading instrument "+h+"<br>";return eb(h)}).then(function(){b("instr "+h+" geladen");ta[h]=1;fa(a)})["catch"](function(a){Sa(a);Va[h]=1;c(h)}):c(h)}else Oa=1,q.style.display="none"}function bb(a){a=Object.keys(a).filter(function(a){return!(a in Ba)});a.length&&(q.innerHTML="",q.style.display=
"block",fa(a))}function hb(){var a,d="",c="",m,k,h,p,l,f,g={};F.innerHTML="";a=window.location.href.replace("?dl=0","").split("?");if(1<a.length)for(a=a[1].split("&"),l=0;l<a.length;l++)g=a[l].replace(/d:(\w{15}\/[^.]+\.)/,"https://dl.dropboxusercontent.com/s/$1"),"noErr"==g?h=1:"noMenu"==g?m=1:"noSave"==g?k=1:"noErr"==g?h=1:"noDash"==g?p=1:"noRT"==g?R=0:"noPF"==g?Ga=1:"noLB"==g?Ha=1:(f=g.match(/noCur=([\da-fA-F]{2})/))?la=parseInt(f[1],16):c=g;g=(f=document.getElementById("parms"))?JSON.parse(f.innerHTML):
{};void 0!=g.topSpace&&(pa=g.topSpace);void 0!=g.notationHeight&&(Wa=g.notationHeight);void 0!=g.fileURL&&(c=g.fileURL);void 0!=g.gTempo&&(O=g.gTempo);void 0!=g.noCur&&(la=g.noCur);if(void 0!=g.noDash&&g.noDash||p)P.style.visibility="hidden";if(void 0!=g.noSave&&g.noSave||k)document.getElementById("savlbl").style.display="none";if(void 0!=g.noMenu&&g.noMenu||m)document.getElementById("mbar").style.display="none";if(void 0!=g.noErr&&g.noErr||h)F.style.display="none",F.style.height="0px";/(\.xml$)|(\.abc$)/.test(c)&&
(d=c,c="");if(d){var r=document.getElementById("wait");r.style.display="block";var q=new XMLHttpRequest;q.open("GET",d,!0);q.onload=function(){b("preload ok");e(q.response);ea.style.display="block";r.style.display="none"};q.onerror=function(){r.innerHTML+="\npreload failed"};q.send()}}function Xa(){var a=F.clientHeight,a=Math.round(100*a/document.documentElement.clientHeight);r.style.height=Wa-a+"%"}function ib(){var a="",d="";if(ja&&((new Abc({imagesize:'width="100%"',img_out:function(b){a+=b},errmsg:function(a,
b,c){d+=a+"\n"},read_file:null,anno_start:null,get_abcmodel:null})).tosvg("abc2svg",ja),""==d&&(d="no error\n"),b(d),a)){var c,e,k='<html><meta charset="utf-8"><div>\n'+a+"\n</div></html>\n";e=ia+".html";try{c=document.createElement("a"),c.href="data:text/plain;charset=utf-8,"+encodeURIComponent(k),c.download=e,c.text="Save ABC file",document.getElementById("saveDiv").appendChild(c),c.click()}catch(h){confirm("Do you want to save the ABC text?")&&(document.open("text/html"),document.write("<pre>"+
k+"</pre>"),document.close())}}}function ba(a,b,c){function d(b){a.removeEventListener("mousedown",d);a.removeEventListener("touchend",d);console.log("event listeners removed from "+a.nodeName+"#"+a.id);v&&"suspended"==v.state&&v.resume().then(function(){console.log("resuming audioContext")})}a.addEventListener("mousedown",d);a.addEventListener("touchend",d);a.addEventListener(b,c)}function Ya(){function a(a){I.checked=!a;I.disabled=a;Za.style.color=a?"#aaa":"#000"}if("undefined"==typeof Dropbox){a(!0);
var e=document.createElement("script");e.src="https://www.dropbox.com/static/api/2/dropins.js";e.onload=function(){a(!1);Dropbox.init({appKey:"ckknarypgq10318"});var b=Dropbox.createChooseButton({success:d,cancel:function(){},linkType:"direct",multiselect:!1,extensions:[".xml",".abc"]});$a.append(b);Ya()};e.onerror=function(){b("loading dropbox API failed")};document.head.appendChild(e)}else document.querySelector(".dropbox-dropin-btn").style.display=I.checked?"inline-block":"none",V.style.display=
I.checked?"none":"inline-block"}var ja,L,Ka,ia,C=0,Na=0,wa,Oa=0,z=[],W=[],ra={},oa={},aa=[],H=[],qa=[],cb,pa=500,ma,Y,na=0,X=[],La=0,ka=[],v=null,Qa=[],xa=[],Ba={},Wa=100,ha=null,Ja=[],Va={},Ta={},ta={},Ca=[],Ia={},J=[],K=[],r=null,q,F,$a,P,V,M,I,Za,Da,S,ea,da,gb="acoustic_grand_piano bright_acoustic_piano electric_grand_piano honkytonk_piano electric_piano_1 electric_piano_2 harpsichord clavinet celesta glockenspiel music_box vibraphone marimba xylophone tubular_bells dulcimer drawbar_organ percussive_organ rock_organ church_organ reed_organ accordion harmonica tango_accordion acoustic_guitar_nylon acoustic_guitar_steel electric_guitar_jazz electric_guitar_clean electric_guitar_muted overdriven_guitar distortion_guitar guitar_harmonics acoustic_bass electric_bass_finger electric_bass_pick fretless_bass slap_bass_1 slap_bass_2 synth_bass_1 synth_bass_2 violin viola cello contrabass tremolo_strings pizzicato_strings orchestral_harp timpani string_ensemble_1 string_ensemble_2 synth_strings_1 synth_strings_2 choir_aahs voice_oohs synth_choir orchestra_hit trumpet trombone tuba muted_trumpet french_horn brass_section synth_brass_1 synth_brass_2 soprano_sax alto_sax tenor_sax baritone_sax oboe english_horn bassoon clarinet piccolo flute recorder pan_flute blown_bottle shakuhachi whistle ocarina lead_1_square lead_2_sawtooth lead_3_calliope lead_4_chiff lead_5_charang lead_6_voice lead_7_fifths lead_8_bass__lead pad_1_new_age pad_2_warm pad_3_polysynth pad_4_choir pad_5_bowed pad_6_metallic pad_7_halo pad_8_sweep fx_1_rain fx_2_soundtrack fx_3_crystal fx_4_atmosphere fx_5_brightness fx_6_goblins fx_7_echoes fx_8_scifi sitar banjo shamisen koto kalimba bagpipe fiddle shanai tinkle_bell agogo steel_drums woodblock taiko_drum melodic_tom synth_drum reverse_cymbal guitar_fret_noise breath_noise seashore bird_tweet telephone_ring helicopter applause gunshot".split(" "),
Ua={},O=120,N=120,sa=1,ua=[],va=[],R=1,Ga=0,Ha=0,la=0,ca=1,ya=1,za=1,Aa=1;document.addEventListener("DOMContentLoaded",function(){q=document.getElementById("comp");r=document.getElementById("notation");F=document.getElementById("err");P=document.getElementById("rollijn");$a=document.getElementById("abcfile");V=document.getElementById("fknp");M=document.getElementById("tempo");ea=document.getElementById("playbk");da=document.getElementById("play");document.getElementById("kwart").appendChild(document.getElementById("mtrsvg"));
ba(da,"click",Z);ba(ea,"click",Z);V.addEventListener("change",m);document.getElementById("save").addEventListener("click",ib);P.addEventListener("mousedown",Fa);P.addEventListener("touchstart",Fa);M.addEventListener("change",db);window.addEventListener("resize",function(){A();Ea();Xa();U()});r.addEventListener("drop",u);r.addEventListener("dragover",function(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect="copy"});r.addEventListener("dragenter",function(){this.classList.add("indrag")});
r.addEventListener("dragleave",function(){this.classList.remove("indrag")});I=document.getElementById("drpuse");I.checked=!1;I.addEventListener("click",Ya);Za=document.getElementById("drplbl");Da=document.getElementById("mbar");S=document.getElementById("menu");S.style.display="none";Da.addEventListener("click",function(a){a.stopPropagation();a="none"==S.style.display;S.style.display=a?"block":"none";Da.style.background=a?"#aaa":""});S.addEventListener("click",function(a){a.stopPropagation()});hb();
Xa();var a=window.AudioContext||window.webkitAudioContext;if(v=void 0!=a?new a:null){v.createStereoPanner||(ca=0);v.createOscillator||(ya=0);v.createBiquadFilter||(za=0);v.createConstantSource||(Aa=0);var a=[],b=0;ca||a.push("Your browser does not support the StereoPanner element");R&&!ya&&(a.push("Your browser does not support the Oscillator element"),b=1);R&&!za&&(a.push("Your browser does not support the BiquadFilter element"),b=1);R&&!Aa&&(a.push("Your browser does not support the ConstantSource element"),
b=1);a.length&&alert(a.join("\n")+(b?"\nThe instrument(s) will sound (very) wrong":""))}else alert("Your browser has no Web Audio API -> no playback.");document.getElementById("verlab").innerHTML="<span>Version:</span>"+xmlplay_VERSION})})();
